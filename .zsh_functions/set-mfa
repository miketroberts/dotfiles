MY_MFA_DEVICE=arn:aws:iam::472882997329:mfa/mike.roberts@narvar.com
if [ $# -lt 2 ]
then
    echo "Usage: ${0} <my-profile> <my-mfa-token>"
    echo "  Configures a new profile, <my-profile>-mfa, with session"
    echo "Example: ${0} dev 123456"
    echo "  Produces profile 'dev-mfa'"
    echo "  aws s3 ls --profile dev-mfa"
    exit 2
fi
_run
_configure() {
    aws-vault exec $1 -- aws configure set region $2 --profile $1-mfa
    aws-vault exec $1 -- aws configure set aws_access_key_id $3 --profile $1-mfa
    aws-vault exec $1 -- aws configure set aws_secret_access_key $4 --profile $1-mfa
    aws-vault exec $1 -- aws configure set aws_session_token $5 --profile $1-mfa
}
_configure $1 $(aws-vault exec $1 -- aws configure get region --profile $1) $(aws-vault exec $1 -- aws sts get-session-token --profile $1 --serial-number $MY_MFA_DEVICE --token-code $2 --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --output text)
